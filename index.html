<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sang Fa — Attendance (Full Form)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --muted:#666; --accent:#0b6efd;
    --ok:#16a34a; --bad:#dc2626; --late:#f59e0b;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:var(--bg);color:#111;padding:12px}
  header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .small{color:var(--muted);font-size:13px}
  .top{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0}
  input,textarea,select,button{font-size:14px}
  input[type=text], textarea, input[type=tel], input[type=date], input[type=number]{padding:10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;width:100%}
  .controls{display:grid;grid-template-columns:1fr auto;gap:8px;width:100%;max-width:1200px}
  .btn{padding:9px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .btn.ghost{background:#fff;color:var(--accent);border:1px solid #dbeafe}
  .btn.warn{background:var(--bad)}
  .layout{display:grid;grid-template-columns:1fr;gap:12px;max-width:1200px;margin-top:10px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 1px 6px rgba(12,18,30,.04)}
  .student-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:10px}
  .student{padding:10px;border-radius:8px;border:1px solid #eef2ff;background:#fff;display:flex;flex-direction:column;gap:8px}
  .name{font-weight:600}
  .roll{font-size:12px;color:var(--muted)}
  .status-row{display:flex;gap:6px;align-items:center}
  .sbtn{flex:1;padding:8px;border-radius:8px;border:none;cursor:pointer}
  .present{background:var(--ok);color:#fff}
  .absent{background:var(--bad);color:#fff}
  .late{background:var(--late);color:#fff}
  .smallmuted{font-size:12px;color:var(--muted)}
  .top-actions{display:flex;gap:8px;flex-wrap:wrap}
  #qrCanvas{max-width:100%;border-radius:8px}
  @media (min-width:880px){
    .layout{grid-template-columns:420px 1fr}
    .controls{grid-template-columns:1fr auto}
  }
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:18px}
  .modal .card{max-width:760px;width:100%}
  label{font-size:13px;color:#333;display:block;margin-bottom:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .col{flex:1;min-width:120px}
</style>
</head>
<body>

<header>
  <div>
    <h1>Sang Fa — Attendance (Full)</h1>
    <div class="small">Full student profiles, QR, device assignment, CSV export, monthly reports.</div>
  </div>
</header>

<div class="top">
  <div class="controls">
    <input id="classSelect" placeholder="Class / Trainer name (e.g., Ashim Gogoi)"/>
    <div style="display:flex;gap:8px">
      <button id="setClassBtn" class="btn">Set</button>
      <button id="adminBtn" class="btn ghost">Admin</button>
    </div>
  </div>

  <div class="top-actions">
    <button id="exportDayBtn" class="btn">Export Today's CSV</button>
    <button id="monthlyReportBtn" class="btn ghost">Monthly Report</button>
    <button id="feesReportBtn" class="btn ghost">Monthly Fees CSV</button>
  </div>
</div>

<div class="layout">
  <!-- Left: Student Form + saved -->
  <div class="card">
    <strong>Add / Edit Student</strong>
    <div class="smallmuted">Fill details and click Add Student</div>
    <div style="margin-top:8px">
      <div class="row">
        <div class="col"><label>Registration No.</label><input id="regNo" placeholder="R001 or your ID"/></div>
        <div class="col"><label>Name</label><input id="sname" placeholder="Student full name"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><label>D.O.B</label><input id="dob" type="date"/></div>
        <div class="col"><label>Father Name</label><input id="father"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><label>Phone</label><input id="phone" type="tel" placeholder="10 digit"/></div>
        <div class="col"><label>Belt Rank</label><input id="belt" placeholder="White/Yellow/Blue..."/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><label>Aadhaar No</label><input id="aadhaar" placeholder="xxxx xxxx xxxx"/></div>
        <div class="col"><label>Level</label>
          <select id="level">
            <option value="Beginner">Beginner</option>
            <option value="Advance">Advance</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="col"><label>Monthly Fee (₹)</label><input id="monthlyFee" type="number" min="0" placeholder="0"/></div>
        <div class="col" style="align-self:flex-end">
          <button id="addStudentBtn" class="btn">Add Student</button>
          <button id="updateStudentBtn" class="btn ghost" style="display:none">Update</button>
        </div>
      </div>
    </div>

    <hr style="margin:12px 0"/>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>Saved Students</strong>
      <div class="smallmuted" id="countStudents">0 students</div>
    </div>

    <div class="student-list" id="savedList"></div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="exportStudentsBtn" class="btn ghost">Export Student CSV</button>
      <button id="clearAllStudentsBtn" class="btn warn">Clear All</button>
    </div>

    <hr style="margin:12px 0"/>
    <div><strong>QR Tools</strong>
      <div class="smallmuted">Generate QR for a student or Scan to mark Present</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <select id="qrStudentSelect" style="flex:1"></select>
        <button id="genQRBtn" class="btn">Generate</button>
        <button id="scanQRBtn" class="btn ghost">Scan</button>
      </div>
      <div id="qrPreview" style="margin-top:8px"></div>
      <div id="scannerArea" style="margin-top:8px"></div>
    </div>

  </div>

  <!-- Right: Attendance -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <div>
        <div class="smallmuted">Class: <strong id="classNameText">Default</strong></div>
        <div class="smallmuted">Date: <strong id="todayText"></strong></div>
      </div>
      <div class="smallmuted">Tap to mark — or scan QR</div>
    </div>

    <div style="margin-top:12px">
      <div id="todayCount" class="smallmuted">0 marked</div>
      <div class="student-list" id="attendanceGrid" style="margin-top:8px"></div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button id="exportBtn" class="btn">Export Today's CSV</button>
      <button id="saveBtn" class="btn ghost">Save Today</button>
      <button id="resetStatuses" class="btn ghost">Reset All to Absent</button>
      <button id="exportMonthlyCSV" class="btn ghost">Export Monthly CSV</button>
    </div>

    <div style="margin-top:12px;color:var(--muted);font-size:12px">
      Tip: Add students once. To mark by QR, generate each student's QR and print/share it. Scanning marks Present.
    </div>
  </div>
</div>

<!-- Admin modal -->
<div id="modal" class="modal"><div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <strong>Admin Panel</strong>
    <button id="closeModal" class="btn ghost">Close</button>
  </div>

  <div style="margin-top:10px">
    <label>Set / Change Admin PIN (4-8 digits)</label>
    <div class="row">
      <input id="adminPinInput" placeholder="e.g., 1234 (4-8 digits)"/>
      <button id="savePinBtn" class="btn ghost">Save PIN</button>
    </div>

    <hr/>

    <div><strong>Device assignment</strong>
      <div class="smallmuted">Assign this device to a trainer/class. Once assigned, trainer cannot switch classes without Admin PIN.</div>
      <div class="row" style="margin-top:8px">
        <select id="deviceAssignSelect" style="flex:1"></select>
        <button id="assignDeviceBtn" class="btn">Assign Device</button>
        <button id="clearDeviceBtn" class="btn ghost">Clear</button>
      </div>
      <div class="smallmuted" id="deviceAssignedText" style="margin-top:8px"></div>
    </div>

    <hr/>

    <div><strong>Firebase (optional)</strong>
      <div class="smallmuted">Paste Firebase config JSON here to enable cloud sync (optional).</div>
      <textarea id="firebaseConfig" rows="4" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="saveFirebaseBtn" class="btn">Save Firebase Config</button>
        <button id="connectFirebaseBtn" class="btn ghost">Connect / Sync Now</button>
      </div>
      <div id="firebaseStatus" class="smallmuted" style="margin-top:8px"></div>
    </div>
  </div>
</div></div>

<!-- dependencies -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
/* ---------------- App constants & keys ---------------- */
const APP_PREFIX = 'sangfa_full_v2';
const LS_CONFIG = APP_PREFIX + '_config';
const LS_CLASSES = APP_PREFIX + '_classes';
const LS_STUDENTS_PREFIX = APP_PREFIX + '_students_'; // + class
const LS_ATT_PREFIX = APP_PREFIX + '_att_'; // + class + '_' + date
const LS_DEVICE = APP_PREFIX + '_device'; // assigned device info

/* ---------------- DOM ---------------- */
const classSelect = document.getElementById('classSelect');
const setClassBtn = document.getElementById('setClassBtn');
const classNameText = document.getElementById('classNameText');
const todayText = document.getElementById('todayText');
const countStudents = document.getElementById('countStudents');
const savedList = document.getElementById('savedList');
const attendanceGrid = document.getElementById('attendanceGrid');
const todayCount = document.getElementById('todayCount');

const regNo = document.getElementById('regNo');
const sname = document.getElementById('sname');
const dob = document.getElementById('dob');
const father = document.getElementById('father');
const phone = document.getElementById('phone');
const belt = document.getElementById('belt');
const aadhaar = document.getElementById('aadhaar');
const level = document.getElementById('level');
const monthlyFee = document.getElementById('monthlyFee');
const addStudentBtn = document.getElementById('addStudentBtn');
const updateStudentBtn = document.getElementById('updateStudentBtn');

const exportStudentsBtn = document.getElementById('exportStudentsBtn');
const clearAllStudentsBtn = document.getElementById('clearAllStudentsBtn');

const qrStudentSelect = document.getElementById('qrStudentSelect');
const genQRBtn = document.getElementById('genQRBtn');
const qrPreview = document.getElementById('qrPreview');
const scanQRBtn = document.getElementById('scanQRBtn');
const scannerArea = document.getElementById('scannerArea');

const exportBtn = document.getElementById('exportBtn');
const exportDayBtn = document.getElementById('exportDayBtn');
const exportMonthlyCSV = document.getElementById('exportMonthlyCSV');
const monthlyReportBtn = document.getElementById('monthlyReportBtn');
const feesReportBtn = document.getElementById('feesReportBtn');
const saveBtn = document.getElementById('saveBtn');
const resetStatuses = document.getElementById('resetStatuses');

const adminBtn = document.getElementById('adminBtn');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');
const adminPinInput = document.getElementById('adminPinInput');
const savePinBtn = document.getElementById('savePinBtn');

const deviceAssignSelect = document.getElementById('deviceAssignSelect');
const assignDeviceBtn = document.getElementById('assignDeviceBtn');
const clearDeviceBtn = document.getElementById('clearDeviceBtn');
const deviceAssignedText = document.getElementById('deviceAssignedText');

const firebaseConfigBox = document.getElementById('firebaseConfig');
const saveFirebaseBtn = document.getElementById('saveFirebaseBtn');
const connectFirebaseBtn = document.getElementById('connectFirebaseBtn');
const firebaseStatus = document.getElementById('firebaseStatus');

/* ---------------- State ---------------- */
let config = loadJSON(LS_CONFIG, {adminPinHash: null, firebaseConfig: null});
let classes = loadJSON(LS_CLASSES, ['Ashim Gogoi']) || ['Ashim Gogoi'];
let currentClass = classes[0];
let students = []; // array of objects: {regNo,name,dob,father,phone,belt,aadhaar,level,monthlyFee}
let attendance = {}; // {regNo: 'present'|'absent'|'late'}
let editingIndex = -1;
let scanning=false, videoStream=null;

/* ---------------- Helpers ---------------- */
function todayStr(d=new Date()){ return d.toISOString().slice(0,10); }
function loadJSON(k, def){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def;}catch(e){return def;} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function studentsKey(cls){ return LS_STUDENTS_PREFIX + cls; }
function attKey(cls, dateStr){ return LS_ATT_PREFIX + cls + '_' + dateStr; }
function hashPin(pin){ let h=0; for(let i=0;i<pin.length;i++){ h = ((h<<5)-h) + pin.charCodeAt(i); h |= 0;} return String(h); }
function downloadBlob(text, filename){ const blob=new Blob([text], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }

/* ---------------- Load / Save ---------------- */
function loadApp(){
  config = loadJSON(LS_CONFIG, {adminPinHash:null, firebaseConfig:null});
  classes = loadJSON(LS_CLASSES, classes);
  if(!classes.includes(currentClass)) classes.unshift(currentClass);
  classSelect.value = currentClass;
  loadStudents();
  loadAttendance();
  refreshDeviceUI();
  renderUI();
}
function saveConfig(){ saveJSON(LS_CONFIG, config); }
function saveStudents(){ saveJSON(studentsKey(currentClass), students); renderSavedList(); }
function loadStudents(){ students = loadJSON(studentsKey(currentClass), []); renderSavedList(); }
function saveAttendance(){ saveJSON(attKey(currentClass, todayStr()), attendance); renderAttendanceGrid(); }
function loadAttendance(){ attendance = loadJSON(attKey(currentClass, todayStr()), {}); renderAttendanceGrid(); }

/* ---------------- Render functions ---------------- */
function renderUI(){
  classNameText.textContent = currentClass;
  todayText.textContent = new Date().toLocaleString();
}
function renderSavedList(){
  savedList.innerHTML=''; qrStudentSelect.innerHTML='';
  countStudents.textContent = students.length + ' students';
  students.forEach((s,i)=>{
    const el=document.createElement('div'); el.className='student';
    const nm=document.createElement('div'); nm.className='name'; nm.textContent = s.name;
    const rl=document.createElement('div'); rl.className='roll'; rl.textContent = 'Reg: '+s.regNo + ' • ' + s.level;
    const details=document.createElement('div'); details.className='smallmuted';
    details.textContent = `DOB: ${s.dob || '-'} | Father: ${s.father || '-'} | Phone: ${s.phone || '-'} | Belt: ${s.belt || '-'} | Aadhaar: ${s.aadhaar || '-' } | Fee: ${s.monthlyFee || 0}`;
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='6px';
    const useBtn=document.createElement('button'); useBtn.className='btn ghost'; useBtn.textContent='Use';
    useBtn.onclick = ()=> { startUsingStudent(i); };
    const editBtn=document.createElement('button'); editBtn.className='btn'; editBtn.textContent='Edit';
    editBtn.onclick = ()=> { startEditStudent(i); };
    const delBtn=document.createElement('button'); delBtn.className='btn warn'; delBtn.textContent='Delete';
    delBtn.onclick = ()=> { if(confirm('Delete '+s.name+'?')){ students.splice(i,1); saveStudents(); loadAttendance(); } };
    const qrBtn=document.createElement('button'); qrBtn.className='btn ghost'; qrBtn.textContent='QR';
    qrBtn.onclick = ()=> { generateQRForStudent(s); };
    row.appendChild(useBtn); row.appendChild(editBtn); row.appendChild(qrBtn); row.appendChild(delBtn);
    el.appendChild(nm); el.appendChild(rl); el.appendChild(details); el.appendChild(row);
    savedList.appendChild(el);

    // select option
    const opt=document.createElement('option'); opt.value = s.regNo; opt.textContent = `${s.regNo} • ${s.name}`;
    qrStudentSelect.appendChild(opt);
  });
  renderAttendanceGrid();
}
function renderAttendanceGrid(){
  attendanceGrid.innerHTML='';
  classNameText.textContent = currentClass;
  todayText.textContent = new Date().toLocaleString();
  students.forEach((s,i)=>{
    const key = s.regNo;
    const st = attendance[key] || 'absent';
    const c=document.createElement('div'); c.className='student';
    const n=document.createElement('div'); n.className='name'; n.textContent = s.name;
    const r=document.createElement('div'); r.className='roll'; r.textContent = s.regNo + (s.level? ' • '+s.level : '');
    const stRow=document.createElement('div'); stRow.className='status-row';
    const b1=document.createElement('button'); b1.className='sbtn present'; b1.textContent='Present';
    const b2=document.createElement('button'); b2.className='sbtn absent'; b2.textContent='Absent';
    const b3=document.createElement('button'); b3.className='sbtn late'; b3.textContent='Late';
    const highlight=(el,on)=> el.style.opacity = on? '1' : '0.6';
    highlight(b1, st==='present'); highlight(b2, st==='absent'); highlight(b3, st==='late');
    b1.onclick = ()=>{ attendance[key]='present'; saveAttendance(); renderAttendanceGrid(); };
    b2.onclick = ()=>{ attendance[key]='absent'; saveAttendance(); renderAttendanceGrid(); };
    b3.onclick = ()=>{ attendance[key]='late'; saveAttendance(); renderAttendanceGrid(); };
    stRow.appendChild(b1); stRow.appendChild(b2); stRow.appendChild(b3);
    c.appendChild(n); c.appendChild(r); c.appendChild(stRow);
    attendanceGrid.appendChild(c);
  });
  const total = students.length;
  const marked = Object.keys(attendance).length;
  todayCount.textContent = `${marked} marked / ${total} total`;
}

/* ---------------- Student add/edit ---------------- */
function clearForm(){ regNo.value=''; sname.value=''; dob.value=''; father.value=''; phone.value=''; belt.value=''; aadhaar.value=''; level.value='Beginner'; monthlyFee.value=''; editingIndex=-1; updateStudentBtn.style.display='none'; addStudentBtn.style.display='inline-block'; }
function startEditStudent(i){
  const s = students[i];
  regNo.value = s.regNo; sname.value = s.name; dob.value=s.dob||''; father.value=s.father||''; phone.value=s.phone||''; belt.value=s.belt||''; aadhaar.value=s.aadhaar||''; level.value = s.level||'Beginner'; monthlyFee.value = s.monthlyFee||'';
  editingIndex = i;
  updateStudentBtn.style.display='inline-block'; addStudentBtn.style.display='none';
}
function startUsingStudent(i){
  // quick: prefill form to create QR or to mark
  const s = students[i];
  alert('Using student: ' + s.name + '\\nYou can generate QR or mark attendance.');
}

addStudentBtn.onclick = ()=>{
  const s = {
    regNo: (regNo.value || '').trim() || generateRegNo(),
    name: (sname.value || '').trim(),
    dob: (dob.value || '').trim(),
    father: (father.value || '').trim(),
    phone: (phone.value || '').trim(),
    belt: (belt.value || '').trim(),
    aadhaar: (aadhaar.value || '').trim(),
    level: level.value,
    monthlyFee: monthlyFee.value ? Number(monthlyFee.value) : 0
  };
  if(!s.name){ return alert('Enter student name'); }
  if(students.find(x=>x.regNo === s.regNo)){ return alert('Registration No already exists. Use edit to update.'); }
  students.push(s);
  saveStudents();
  clearForm();
  alert('Student added.');
};

updateStudentBtn.onclick = ()=>{
  if(editingIndex < 0) return;
  const s = students[editingIndex];
  s.regNo = (regNo.value || '').trim();
  s.name = (sname.value || '').trim();
  s.dob = (dob.value || '').trim();
  s.father = (father.value || '').trim();
  s.phone = (phone.value || '').trim();
  s.belt = (belt.value || '').trim();
  s.aadhaar = (aadhaar.value || '').trim();
  s.level = level.value;
  s.monthlyFee = monthlyFee.value ? Number(monthlyFee.value) : 0;
  saveStudents();
  clearForm();
  alert('Student updated.');
};

function generateRegNo(){
  // create R001 like auto number
  let max=0;
  students.forEach(s=>{
    const m = s.regNo.replace(/[^\d]/g,'') || '0';
    const n = parseInt(m,10) || 0;
    if(n>max) max=n;
  });
  return 'R' + String(max+1).padStart(3,'0');
}

/* ---------------- Export functions ---------------- */
function exportStudentsCSV(){
  if(students.length===0) return alert('No students');
  const rows = ['regNo,name,dob,father,phone,belt,aadhaar,level,monthlyFee'];
  students.forEach(s => {
    rows.push(`"${s.regNo}","${s.name.replace(/"/g,'""')}","${s.dob}","${s.father.replace(/"/g,'""')}","${s.phone}","${s.belt}","${s.aadhaar}","${s.level}",${s.monthlyFee||0}`);
  });
  downloadBlob(rows.join('\\n'), `${currentClass}_students.csv`);
}

function exportTodayCSV(){
  const date = todayStr();
  const rows = ['class,date,regNo,name,status'];
  students.forEach(s=>{
    const st = attendance[s.regNo] || 'absent';
    rows.push(`${currentClass},${(new Date()).toISOString()},"${s.regNo}","${s.name.replace(/"/g,'""')}",${st}`);
  });
  downloadBlob(rows.join('\\n'), `attendance_${currentClass}_${date}.csv`);
}

function exportMonthlyCSV(){
  const now = new Date(); const year = now.getFullYear(); const month = now.getMonth()+1;
  const totals = collectMonthData(year, month);
  const rows = ['regNo,name,present,absent,late,total,percent'];
  Object.values(totals).forEach(t=>{
    const pct = t.total ? Math.round((t.present / t.total) * 100) : 0;
    rows.push(`"${t.roll}","${t.name.replace(/"/g,'""')}",${t.present},${t.absent},${t.late},${t.total},${pct}`);
  });
  downloadBlob(rows.join('\\n'), `${currentClass}_monthly_${year}_${String(month).padStart(2,'0')}.csv`);
}

function exportMonthlyFeesCSV(){
  // exports student monthly fee records (basic)
  if(students.length===0) return alert('No students');
  const rows = ['regNo,name,monthlyFee'];
  students.forEach(s => rows.push(`"${s.regNo}","${s.name.replace(/"/g,'""')}",${s.monthlyFee||0}`));
  downloadBlob(rows.join('\\n'), `${currentClass}_fees_list.csv`);
}

/* ---------------- Monthly calculations ---------------- */
function collectMonthData(year, month){
  const totals = {}; // regNo -> {name, roll, present, absent, late, total}
  students.forEach(s=> totals[s.regNo] = {name:s.name, roll:s.regNo, present:0, absent:0, late:0, total:0});
  const start = new Date(year, month-1, 1);
  const end = new Date(year, month, 0);
  for(let d=1; d<=end.getDate(); d++){
    const dateStr = start.toISOString().slice(0,8) + String(d).padStart(2,'0');
    const dayAtt = loadJSON(attKey(currentClass, dateStr), {});
    Object.keys(dayAtt).forEach(k=>{
      if(!totals[k]) totals[k] = {name:k, roll:k, present:0, absent:0, late:0, total:0};
      totals[k].total++;
      if(dayAtt[k] === 'present') totals[k].present++;
      else if(dayAtt[k] === 'absent') totals[k].absent++;
      else if(dayAtt[k] === 'late') totals[k].late++;
    });
  }
  return totals;
}

function showMonthlyReport(){
  const now = new Date();
  const year = now.getFullYear(); const month = now.getMonth()+1;
  const totals = collectMonthData(year, month);
  let text = `Monthly report for ${currentClass}: ${year}-${String(month).padStart(2,'0')}\\n\\n`;
  Object.values(totals).forEach(t=>{
    const pct = t.total ? Math.round((t.present / t.total) * 100) : 0;
    text += `${t.name} (${t.roll}) — Present: ${t.present}, Absent: ${t.absent}, Late: ${t.late}, %: ${pct}%\\n`;
  });
  alert(text);
}

/* ---------------- Reset & Save ---------------- */
resetStatuses.onclick = ()=>{
  if(!confirm('Set everyone to Absent for today?')) return;
  attendance = {};
  students.forEach(s=> attendance[s.regNo] = 'absent');
  saveAttendance(); renderAttendanceGrid();
};
saveBtn.onclick = ()=>{ saveAttendance(); alert('Saved today attendance.'); };

/* ---------------- QR generation & scanning ---------------- */
async function generateQRForStudent(s){
  const data = `sangfa:${currentClass}:${s.regNo}`;
  try{
    const url = await QRCode.toDataURL(data, {width:400});
    qrPreview.innerHTML = '';
    const img = document.createElement('img'); img.src=url; img.style.maxWidth='100%';
    const dl = document.createElement('a'); dl.href=url; dl.download = `${(s.regNo||s.name)}_qr.png`; dl.textContent='Download QR'; dl.className='btn'; dl.style.display='inline-block'; dl.style.marginTop='8px';
    qrPreview.appendChild(img); qrPreview.appendChild(dl);
  }catch(e){ alert('QR error'); }
}
genQRBtn.onclick = ()=>{
  const val = qrStudentSelect.value;
  if(!val) return alert('Choose a student');
  const s = students.find(x=>x.regNo===val);
  if(!s) return alert('Student not found');
  generateQRForStudent(s);
};

scanQRBtn.onclick = async ()=>{
  if(scanning){ stopScan(); return; }
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return alert('Camera not supported');
  scannerArea.innerHTML = '';
  const video = document.createElement('video'); video.setAttribute('playsinline','true'); video.style.width='100%'; scannerArea.appendChild(video);
  scanning = true; scanQRBtn.textContent='Stop Scan';
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = stream; video.play(); videoStream = stream;
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    const tick = ()=>{
      if(video.readyState === video.HAVE_ENOUGH_DATA){
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        try{
          const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
          const code = jsQR(imgData.data, imgData.width, imgData.height);
          if(code){
            const data = code.data;
            stopScan();
            processQRData(data);
            return;
          }
        }catch(e){}
      }
      if(scanning) requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }catch(e){
    scanning=false; scanQRBtn.textContent='Scan'; alert('Camera error or permission denied.');
  }
};
function stopScan(){ scanning=false; scanQRBtn.textContent='Scan'; if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null;} scannerArea.innerHTML=''; }
function processQRData(data){
  if(!data.startsWith('sangfa:')) return alert('Unknown QR');
  const parts = data.split(':'); const cls = parts[1] || currentClass; const r = parts[2] || '';
  if(cls !== currentClass){
    if(!confirm(`This QR is for class "${cls}". Switch and mark?`)) return;
    switchClass(cls);
  }
  const idx = students.findIndex(s=>s.regNo === r);
  if(idx >= 0){
    attendance[r] = 'present';
    saveAttendance();
    renderAttendanceGrid();
    alert(students[idx].name + ' marked Present.');
  }else{
    alert('Student with Reg ' + r + ' not found in current class.');
  }
}

/* ---------------- Admin panel & device assign ---------------- */
adminBtn.onclick = ()=> {
  // If device assigned to some trainer and current device != assigned and user not admin -> deny
  const device = loadJSON(LS_DEVICE, null);
  if(device && device.deviceId && device.assignedTo){
    // if device assigned and current device is not same owner, ask admin pin to open admin panel
    // allow open but force PIN entry to change assignment
  }
  modal.style.display='flex';
  firebaseConfigBox.value = JSON.stringify(config.firebaseConfig || {});
  refreshDeviceUI();
};
closeModal.onclick = ()=> modal.style.display='none';

savePinBtn.onclick = ()=>{
  const val = adminPinInput.value.trim();
  if(!/^\d{4,8}$/.test(val)) return alert('PIN must be 4-8 digits');
  config.adminPinHash = hashPin(val);
  saveConfig();
  adminPinInput.value='';
  alert('Admin PIN saved.');
};

function refreshDeviceUI(){
  // fill device select with classes/trainer options
  deviceAssignSelect.innerHTML='';
  classes.forEach(c => {
    const opt=document.createElement('option'); opt.value=c; opt.textContent=c; deviceAssignSelect.appendChild(opt);
  });
  const device = loadJSON(LS_DEVICE, null);
  if(device && device.assignedTo){
    deviceAssignedText.textContent = `This device assigned to: ${device.assignedTo}`;
  } else deviceAssignedText.textContent = 'Device not assigned';
}

assignDeviceBtn.onclick = ()=>{
  const target = deviceAssignSelect.value;
  if(!target) return alert('Choose trainer/class to assign');
  const deviceObj = { deviceId: navigator.userAgent || 'web-client', assignedTo: target, assignedAt: new Date().toISOString() };
  saveJSON(LS_DEVICE, deviceObj);
  alert('Device assigned to ' + target);
  refreshDeviceUI();
};

clearDeviceBtn.onclick = ()=>{
  if(!confirm('Clear device assignment?')) return;
  localStorage.removeItem(LS_DEVICE);
  alert('Device assignment cleared');
  refreshDeviceUI();
};

/* ---------------- Firebase helpers (optional) ---------------- */
saveFirebaseBtn.onclick = ()=>{
  try{
    const conf = JSON.parse(firebaseConfigBox.value || '{}');
    config.firebaseConfig = conf;
    saveConfig();
    alert('Firebase config saved (local). Click Connect to sync.');
  }catch(e){ alert('Invalid JSON'); }
};
connectFirebaseBtn.onclick = async ()=>{
  if(!config.firebaseConfig || !config.firebaseConfig.apiKey) return alert('Save firebase config first');
  alert('Firebase sync feature is optional and requires a Firebase project. Configure and test separately.');
};

/* ---------------- Buttons wiring ---------------- */
setClassBtn.onclick = ()=>{
  const v=(classSelect.value||'').trim();
  if(!v) return alert('Type class/trainer name');
  if(!classes.includes(v)) classes.push(v);
  currentClass = v;
  saveJSON(LS_CLASSES, classes);
  loadStudents(); loadAttendance(); renderUI();
  alert('Class set to ' + currentClass);
};

exportStudentsBtn.onclick = exportStudentsCSV;
exportBtn.onclick = exportTodayCSV;
exportDayBtn.onclick = exportTodayCSV;
exportMonthlyCSV.onclick = exportMonthlyCSV;
monthlyReportBtn.onclick = showMonthlyReport;
feesReportBtn.onclick = exportMonthlyFeesCSV;
clearAllStudentsBtn.onclick = ()=> { if(!confirm('Delete ALL saved students?')) return; students=[]; saveStudents(); loadAttendance(); };

window.addEventListener('storage', ()=> { loadStudents(); loadAttendance(); });

/* ---------------- Init ---------------- */
function init(){
  // default classes already set
  const savedDevice = loadJSON(LS_DEVICE, null);
  currentClass = localStorage.getItem(LS_CLASSES) ? loadJSON(LS_CLASSES)[0] : currentClass;
  classSelect.value = currentClass;
  loadStudents(); loadAttendance();
  renderUI();
}
init();

</script>
</body>
</html>
